<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Audio Extractor</title>
    <link rel="stylesheet" href="./assets/css/style.css">
    <style>
        .container {
            max-width: 700px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .url-input-group {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .url-input-group input {
            flex: 1;
        }

        .video-preview {
            display: none;
            animation: slideIn 0.5s ease;
        }

        .video-preview.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .video-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .video-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .video-meta {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .video-duration {
            color: #00d4ff;
            font-size: 0.9rem;
        }

        .video-author {
            color: #ccc;
            font-size: 0.85rem;
        }

        .video-date {
            color: #999;
            font-size: 0.8rem;
        }

        .video-views {
            color: #999;
            font-size: 0.8rem;
        }

        .youtube-link {
            display: inline-block;
            margin: 15px 0;
            padding: 10px 16px;
            background: #606060;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 1px solid #808080;
        }

        .youtube-link:hover {
            background: #808080;
            transform: translateY(-1px);
        }

        .timing-help {
            background: rgba(255, 165, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #ffaa00;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .time-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filename-input {
            margin-top: 15px;
        }

        .clear-btn {
            padding: 10px 15px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            border-radius: 8px;
            color: #ffffff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: rgba(255, 107, 107, 0.3);
        }

        .extract-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .extract-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .extract-btn:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .processing {
            text-align: center;
            padding: 20px;
            color: #00d4ff;
            display: none;
        }

        .processing.show {
            display: block;
        }

        .progress-container {
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .spinner {
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .info-box {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid #00d4ff;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: #e0e0e0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .url-input-group {
                flex-direction: column;
                gap: 10px;
            }

            .time-inputs {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .clear-btn {
                order: 3;
            }

            .format-selection {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <img src="./assets/icons/icons8-laser-sword-150-left.png" alt="Saber Icon" class="saber-icon">
            Sound Capture
            <img src="./assets/icons/icons8-laser-sword-150-right.png" alt="Saber Icon" class="saber-icon">
        </h1>
        
        <div class="error" id="error"></div>
        
        <form id="extractForm">
            <!-- STEP 1: Format Selection -->
            <div class="step-section">
                <div class="step-header">Choose Output Format</div>
                <div class="format-selection">
                    <div class="radio-group">
                        <input type="radio" id="formatMp3" name="format" value="mp3">
                        <label for="formatMp3">MP3</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" id="formatWav" name="format" value="wav" checked>
                        <label for="formatWav">WAV</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="saberCompatible" checked>
                        <label for="saberCompatible">Saber Compatible</label>
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #aaa;" id="formatDescription">
                    16-bit, 44.1kHz, mono, uncompressed WAV (PCM) format
                </div>
            </div>

            <!-- STEP 2: URL Input and Load -->
            <div class="step-section">
                <div class="step-header">Enter YouTube URL and Load Video</div>
                <div class="url-input-group">
                    <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." required>
                    <button type="button" class="load-btn" id="loadBtn">Load Video</button>
                </div>
            </div>

            <!-- STEP 3: Video Preview (Hidden Initially) -->
            <div class="step-section video-preview" id="videoPreview">
                <div class="step-header">Find Your Timing</div>
                <div class="video-info">
                    <div class="video-title" id="videoTitle">Video Title</div>
                    <div class="video-meta">
                        <div class="video-duration" id="videoDuration">Duration: 0:00</div>
                        <div class="video-author" id="videoAuthor"></div>
                        <div class="video-date" id="videoDate"></div>
                        <div class="video-views" id="videoViews"></div>
                    </div>
                </div>
                <a href="#" id="youtubeLink" target="_blank" class="youtube-link">
                    Open in YouTube
                </a>
                <div class="timing-help">
                    <strong>💡 How to find precise timing:</strong><br>
                    1. Click "Open in YouTube" above<br>
                    2. Navigate to your desired start point and note the time (e.g., 1:30)<br>
                    3. Navigate to your desired end point and note the time (e.g., 2:45)<br>
                    4. Enter these times in the step below
                </div>
            </div>

            <!-- STEP 4: Time Range and Filename -->
            <div class="step-section">
                <div class="step-header">Configure Output</div>
                <div class="time-inputs">
                    <div class="time-input">
                        <label for="startTime">Start Time</label>
                        <input type="text" id="startTime" placeholder="mm:ss or hh:mm:ss">
                    </div>
                    <div class="time-input">
                        <label for="endTime">End Time</label>
                        <input type="text" id="endTime" placeholder="mm:ss or hh:mm:ss">
                    </div>
                    <button type="button" class="clear-btn" id="clearBtn">🗑️ Clear</button>
                </div>
                <div class="filename-input">
                    <label for="filename">Custom Filename (Optional)</label>
                    <input type="text" id="filename" placeholder="e.g., my-saber-sound">
                </div>
                <div style="font-size: 0.8rem; color: #aaa; margin-top: 10px;">
                    💡 Leave times blank to extract the entire video. Filename will auto-generate from video title if left blank.
                </div>
            </div>

            <!-- STEP 5: Extract -->
            <button type="submit" class="extract-btn" id="extractBtn">Extract Audio</button>
        </form>

        <div class="processing" id="processing">
            <div class="spinner"></div>
            <div>Processing your audio extraction...</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text">
                <span id="processingStatus">Starting extraction...</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <div class="info-box">
            <strong>Supported URLs:</strong> YouTube videos and YouTube Shorts<br>
            <strong>Saber Compatible:</strong> Optimized for lightsaber soundboards (16-bit, 44.1kHz, mono WAV)<br>
            <strong>Time Format:</strong> Use mm:ss (e.g., 1:30) or hh:mm:ss (e.g., 0:01:30)
        </div>
    </div>

    <div style="text-align: center; margin-top: 20px; padding: 15px; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">
        Created by <strong style="color: #00d4ff;">JediMasterTech</strong>
    </div>

    <script>
        let currentVideoData = null;

        // Function to fetch real YouTube metadata via the backend API route
        async function fetchYouTubeMetadata(videoId) {
            try {
                const response = await fetch(`/api/youtube?videoId=${videoId}`);

                if (!response.ok) {
                    throw new Error(`Failed to fetch video data: ${response.status}`);
                }

                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const video = data.items[0];
                    const snippet = video.snippet;
                    const contentDetails = video.contentDetails;
                    const statistics = video.statistics;

                    return {
                        title: snippet.title,
                        author: snippet.channelTitle,
                        publishDate: new Date(snippet.publishedAt).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        }),
                        duration: parseYouTubeDuration(contentDetails.duration),
                        viewCount: parseInt(statistics.viewCount).toLocaleString(),
                        description: snippet.description.substring(0, 200) + '...'
                    };
                } else {
                    throw new Error('Video not found');
                }

            } catch (error) {
                console.error('YouTube API error:', error);
                throw error;
            }
        }

        function parseYouTubeDuration(duration) {
            // Parse YouTube API ISO 8601 duration format (PT4M33S) to readable format (4:33)
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function sanitizeFilename(str) {
            return str.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        function generateFilename() {
            const customFilename = document.getElementById('filename').value.trim();
            const format = document.querySelector('input[name="format"]:checked').value;
            const isSaberCompatible = document.getElementById('saberCompatible').checked;
            
            if (customFilename) {
                return customFilename;
            }
            
            if (currentVideoData && currentVideoData.title) {
                let baseName = sanitizeFilename(currentVideoData.title.substring(0, 50));
                if (format === 'wav' && isSaberCompatible) {
                    baseName += '_saber';
                }
                return baseName;
            }
            
            return 'extracted_audio';
        }

        function updateFormatDescription() {
            const isWav = document.getElementById('formatWav').checked;
            const isSaberCompatible = document.getElementById('saberCompatible').checked;
            const description = document.getElementById('formatDescription');
            const checkbox = document.getElementById('saberCompatible');
            
            if (isWav) {
                checkbox.style.display = 'inline';
                checkbox.parentElement.style.display = 'flex';
                if (isSaberCompatible) {
                    description.textContent = '16-bit, 44.1kHz, mono, uncompressed WAV (PCM) format';
                } else {
                    description.textContent = '16-bit, 48kHz, stereo, uncompressed WAV (PCM) format';
                }
            } else {
                checkbox.style.display = 'none';
                checkbox.parentElement.style.display = 'none';
                description.textContent = 'Compressed MP3 format (320kbps)';
            }
        }

        function updateLoadButtonState() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const loadBtn = document.getElementById('loadBtn');
            
            if (url) {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Video';
            } else {
                loadBtn.disabled = true;
                loadBtn.textContent = 'Load Video';
                document.getElementById('videoPreview').classList.remove('show');
                document.getElementById('extractBtn').disabled = true;
            }
        }

        async function loadVideoPreview() {
            const url = document.getElementById('youtubeUrl').value.trim();
            const loadBtn = document.getElementById('loadBtn');
            
            if (!url) {
                showError('Please enter a YouTube URL');
                return;
            }

            const videoId = extractVideoId(url);
            if (!videoId) {
                showError('Invalid YouTube URL. Please enter a valid YouTube video or short URL.');
                return;
            }

            // Show loading state
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading...';
            loadBtn.classList.add('loading');
            hideError();
            
            try {
                const videoData = await fetchYouTubeMetadata(videoId);
                currentVideoData = videoData;
                
                document.getElementById('videoTitle').textContent = videoData.title;
                document.getElementById('videoDuration').textContent = `Duration: ${videoData.duration}`;
                document.getElementById('videoAuthor').textContent = `Channel: ${videoData.author}`;
                document.getElementById('videoDate').textContent = `Published: ${videoData.publishDate}`;
                
                // Add view count if available
                if (videoData.viewCount) {
                    document.getElementById('videoViews').textContent = `${videoData.viewCount} views`;
                }
                
                document.getElementById('youtubeLink').href = url;
                
                document.getElementById('videoPreview').classList.add('show');
                document.getElementById('extractBtn').disabled = false;
                
                // Reset button
                loadBtn.disabled = false;
                loadBtn.textContent = 'Reload';
                loadBtn.classList.remove('loading');
            } catch (error) {
                showError(`Failed to load video data: ${error.message}`);
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Video';
                loadBtn.classList.remove('loading');
            }
        }

        function clearTimes() {
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            document.getElementById('videoPreview').classList.remove('show');
            document.getElementById('processing').classList.remove('show');
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Event listeners
        document.getElementById('youtubeUrl').addEventListener('input', updateLoadButtonState);
        document.getElementById('loadBtn').addEventListener('click', loadVideoPreview);
        document.getElementById('clearBtn').addEventListener('click', clearTimes);

        document.querySelectorAll('input[name="format"]').forEach(radio => {
            radio.addEventListener('change', updateFormatDescription);
        });

        document.getElementById('saberCompatible').addEventListener('change', updateFormatDescription);

        document.getElementById('extractForm').addEventListener('submit', async e => {
            e.preventDefault();
            hideError();

            const videoUrl = document.getElementById('youtubeUrl').value.trim();
            const formatRadio = document.querySelector('input[name="format"]:checked').value;
            const isSaberCompatible = document.getElementById('saberCompatible').checked;
            const start = document.getElementById('startTime').value || null;
            const end = document.getElementById('endTime').value || null;

            // Determine the actual format to send to backend
            let format = formatRadio;
            if (formatRadio === 'wav' && isSaberCompatible) {
                format = 'saber-wav';
            }

            // Basic validation
            if (!videoUrl) return showError('Please enter a YouTube URL');

            // Generate session ID for progress tracking
            const sessionId = Date.now().toString() + Math.random().toString(36).substr(2, 9);

            const processingDiv = document.getElementById('processing');
            const statusDiv = document.getElementById('processingStatus');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            processingDiv.classList.add('show');
            document.getElementById('extractBtn').disabled = true;
            
            // Reset progress
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            statusDiv.textContent = 'Starting extraction...';

            // Set a longer timeout for the extraction
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 15 * 60 * 1000); // 15 minutes timeout

            try {
                statusDiv.textContent = 'Connecting to server...';
                
                const res = await fetch("/api/extract", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoUrl, format, startTime: start, endTime: end, sessionId }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'Extraction failed');
                }

                statusDiv.textContent = 'Download ready!';
                
                const blob = await res.blob();
                const filename = generateFilename();
                const fileExtension = formatRadio; // Use the original format for file extension
                const fullFilename = `${filename}.${fileExtension}`;
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fullFilename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                
                statusDiv.textContent = 'Download complete!';
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                
                setTimeout(() => {
                    processingDiv.classList.remove('show');
                }, 3000);
                
            } catch (err) {
                if (err.name === 'AbortError') {
                    showError('Extraction timed out. Please try a shorter video or time range.');
                } else {
                    showError('Extraction failed: ' + err.message);
                }
            } finally {
                document.getElementById('extractBtn').disabled = false;
            }
        });

        // Initialize
        updateFormatDescription();
        updateLoadButtonState();
        document.getElementById('extractBtn').disabled = true;
    </script>
</body>
</html>